<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="resources/d3-slider-master/d3.slider.css">
  <link rel="stylesheet" type="text/css" href="resources/css/style.css">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script type ="text/javascript" src ="resources/d3-slider-master/d3.slider.js"/></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>

    <script type="text/javascript">

      window.onload = initialize();

      function initialize(){
        loadData();
      };

      function loadData(){
        queue()
        .defer(d3.csv, "data/prosperLoanData.csv", function(d) {
              d['loanStart'] = new Date(d['LoanOriginationDate']);
              d['loanYear'] = d['loanStart'].getFullYear();
              return d;
            })
        .defer(d3.json, "data/us_states.json")
        .await(callback);

        function callback(error, loanData, geoData){


          function formatData(loanData, callback){

            function agg_state_by_year(leaves){

              var total = d3.sum(leaves, function(d){
                  return d['LoanOriginalAmount'];
              });

              var year = leaves[0]['loanYear']
              var state = leaves[0]['BorrowerState'];

              return {
                'year': year,
                'state': state,
                'total': total
              }
            }

            var nested = d3.nest()
                           .key(function(d) {
                              return d['loanStart'].getUTCFullYear();
                           })
                           .key(function(d) {
                             return d['BorrowerState'];
                           })
                           .rollup(agg_state_by_year)
                           .entries(loanData);

           var total_max = d3.max(nested, function(d) {
               return d.values[0].values['total'];
           });

           callback(nested, geoData)

          }

          formatData(loanData, function(nested, geoData){
            colorMap(nested, geoData)
          });
      }

      function colorMap(nested, geoData){
          var margin = 200,
              width = 1400 - margin,
              height = 600 - margin;

          var svg = d3.select("body")
              .append("svg")
              .attr("width", width + margin)
              .attr("height", height + margin)
              .append('g')
              .attr('class', 'map');

            var projection = d3.geo.albersUsa()
                                    .scale(100)
                                    .translate([width / 2, height / 1.2]);

            var path = d3.geo.path();

             var map = svg.selectAll('path')
                          .data(geoData.features)
                          .enter()
                          .append('path')
                          .attr('d', path)
                          .style('fill', 'lightGrey')
                          .style('stroke', 'black')
                          .style('stroke-width', 0.5);



         var slider_div = d3.select("body")
              .append("div")
              .attr("width", 800)
              .attr('class', 'slider');

          var slider = d3.select(".slider")
                         .call(d3.slider()
                         .axis(true)
                         .min(2006)
                         .max(2014)
                         .step(1)
                         .on("slide", function(evt, {value:geoData}, value) {
                          debugger;
                          console.log("The slider's current value is:" + value);
                          updateMap(value);
                        }));

      }


    }

</script>

  </head>
<body>

</body>
</html>
